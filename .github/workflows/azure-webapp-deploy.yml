name: CI/CD to Azure Web App (Oryx Build)

on:
  push:
    branches: [ main ]

# 避免并发部署相互覆盖
concurrency:
  group: azure-webapp-dream-llm-kevin-alpha
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 仅打包源码（不包含 venv、__pycache__、数据等）
      - name: Create lean artifact for ZipDeploy
        run: |
          cat > .artifactignore <<'EOF'
          .git/
          .github/
          antenv/
          .venv/
          venv/
          __pycache__/
          *.pyc
          .pytest_cache/
          .mypy_cache/
          node_modules/
          logs/
          .DS_Store
          *.log
          .idea/
          .vscode/
          EOF
          zip -r release.zip . -x@.artifactignore

      # 通过 ZipDeploy 上传源码；服务器端由 Oryx 构建
      - name: Deploy to Azure Web App (Oryx server build)
        uses: azure/webapps-deploy@v2
        with:
          app-name: dream-llm-kevin-alpha                 # ← 你的 WebApp 名称
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: release.zip
